<!DOCTYPE html>
<html>
<head>
    <title>Super Admin Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üéµ AudioTricks Super Admin Test</h1>
    
    <div id="results"></div>
    
    <div>
        <button onclick="testLogin()">1. Test Login</button>
        <button onclick="testApiAccess()">2. Test API Access</button>
        <button onclick="testSuperAdminStatus()">3. Test Super Admin Status</button>
        <button onclick="testMenuItems()">4. Test Menu Items</button>
        <button onclick="clearAuth()">Clear Auth</button>
    </div>

    <script>
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = message;
            document.getElementById('results').appendChild(div);
        }

        async function testLogin() {
            addResult('üîÑ Testing login...', 'info');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@audiotricks.com',
                        password: 'admin123'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('authToken', data.token);
                    
                    // Decode token to check role
                    const payload = JSON.parse(atob(data.token.split('.')[1]));
                    
                    addResult(`‚úÖ Login successful! Role in token: ${payload.role}`, 'success');
                    addResult(`User: ${data.user.email}, Role: ${data.user.role}`, 'info');
                } else {
                    const error = await response.text();
                    addResult(`‚ùå Login failed: ${error}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå Login error: ${error.message}`, 'error');
            }
        }

        async function testApiAccess() {
            addResult('üîÑ Testing API access...', 'info');
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                addResult('‚ùå No token found. Please login first.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    addResult('‚úÖ Admin API access successful!', 'success');
                    addResult(`Stats: ${JSON.stringify(data.stats || data).substring(0, 100)}...`, 'info');
                } else {
                    const error = await response.text();
                    addResult(`‚ùå Admin API access failed: ${error}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå API error: ${error.message}`, 'error');
            }
        }

        async function testSuperAdminStatus() {
            addResult('üîÑ Testing super admin status...', 'info');
            
            const token = localStorage.getItem('authToken');
            if (!token) {
                addResult('‚ùå No token found. Please login first.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    const user = data.user;
                    
                    const isAdmin = user.role === 'admin' || user.role === 'super_admin' || user.role === 'superadmin';
                    const isSuperAdmin = user.role === 'super_admin' || user.role === 'superadmin';
                    
                    addResult(`‚úÖ User status: ${user.email}`, 'success');
                    addResult(`Role: ${user.role}`, 'info');
                    addResult(`Is Admin: ${isAdmin ? 'YES' : 'NO'}`, isAdmin ? 'success' : 'error');
                    addResult(`Is Super Admin: ${isSuperAdmin ? 'YES' : 'NO'}`, isSuperAdmin ? 'success' : 'error');
                } else {
                    const error = await response.text();
                    addResult(`‚ùå Auth check failed: ${error}`, 'error');
                }
            } catch (error) {
                addResult(`‚ùå Auth check error: ${error.message}`, 'error');
            }
        }

        function testMenuItems() {
            addResult('üîÑ Testing menu items...', 'info');
            
            // Simulate frontend logic
            const token = localStorage.getItem('authToken');
            if (!token) {
                addResult('‚ùå No token found. Please login first.', 'error');
                return;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                const role = payload.role;
                
                const isAdmin = role === 'admin' || role === 'super_admin' || role === 'superadmin';
                const isSuperAdmin = role === 'super_admin' || role === 'superadmin';
                
                addResult(`Role from token: ${role}`, 'info');
                
                const menuItems = [
                    { name: 'Dashboard', visible: true },
                    { name: 'Users', visible: isAdmin },
                    { name: 'Settings', visible: isAdmin },
                    { name: 'Super Admin', visible: isSuperAdmin }
                ];
                
                menuItems.forEach(item => {
                    const status = item.visible ? '‚úÖ Visible' : '‚ùå Hidden';
                    const type = item.visible ? 'success' : 'error';
                    addResult(`${item.name}: ${status}`, type);
                });
                
            } catch (error) {
                addResult(`‚ùå Token decode error: ${error.message}`, 'error');
            }
        }

        function clearAuth() {
            localStorage.removeItem('authToken');
            addResult('üóëÔ∏è Auth token cleared', 'info');
        }

        // Auto-run initial test
        window.onload = function() {
            addResult('üéµ AudioTricks Super Admin Test Started', 'info');
            addResult('Click buttons above to run tests in order', 'info');
        };
    </script>
</body>
</html>